services:

#---------------------------------------------------------------------------
# n8n service
#---------------------------------------------------------------------------
  n8n:
    container_name: n8n_container
    image: n8nio/n8n:latest
    # Local default: expose 5678 
    ports:
      - "${DOCKER_HOST_PORT_N8N_CONTAINER:-5678}:${N8N_CONTAINER_LISTEN_PORT:-5678}"
    environment:
      # Database
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}

      # node_modules
      # NODE_FUNCTION_ALLOW_BUILTIN: crypto

      # N8N_WARMER_SECRET_KEY
      N8N_WARMER_SECRET_KEY: ${WARMER_SECRET}
      N8N_BLOCK_ENV_ACCESS_IN_NODE: false

      # Encryption
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}

      # Host & URLs (single var pattern)
      N8N_HOST: ${HOSTNAME_N8N_CONTAINER:-localhost}
      N8N_PORT: ${N8N_CONTAINER_LISTEN_PORT:-5678}
      # Protocol remains http; external URLs come from WEBHOOK_URL
      N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
      # If do not exist HOSTNAME , use DOCKER_HOST_PORT
      WEBHOOK_URL: ${N8N_PUBLIC_HOSTNAME:+https://}${N8N_PUBLIC_HOSTNAME:-http://localhost:${DOCKER_HOST_PORT_N8N_CONTAINER:-5678}}/
      # Enable community nodes as tools
      N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE: true
      # Timezone
      GENERIC_TIMEZONE: ${GENERIC_TIMEZONE:-Asia/Tokyo}

      # Redis (queue)
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: ${REDIS_CONTAINER_LISTEN_PORT:-6379}
      QUEUE_BULL_REDIS_DB: ${REDIS_DB:-0}
      QUEUE_BULL_REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      # Cookies secure in prod (set PRODUCTION=true to enable)
      N8N_SECURE_COOKIE: ${PRODUCTION:-false}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: ${PRODUCTION:-false}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./n8n_data:/home/node/.n8n
      # git for nodes. First Create ./n8n_nodes on Host
      - ./n8n_nodes:/home/node/.n8n/nodes
    networks: [app]
    restart: unless-stopped

#---------------------------------------------------------------------------
# postgres service
#---------------------------------------------------------------------------
  postgres:
    container_name: postgres_container
    image: postgres:alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-n8n}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-n8npass}
      POSTGRES_DB: ${POSTGRES_DB:-n8n}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-n8n} -d ${POSTGRES_DB:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [app]
    restart: unless-stopped

#---------------------------------------------------------------------------
# redis service
#---------------------------------------------------------------------------
  redis:
    container_name: redis_container
    image: redis:alpine
    command: ["redis-server", "--appendonly", "yes"]
    # For production, set REDIS_PASSWORD in .env and use:
    # command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - ./redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [app]
    restart: unless-stopped

#---------------------------------------------------------------------------
# searxng service
#---------------------------------------------------------------------------
  searxng:
    container_name: searxng_container
    image: docker.io/searxng/searxng:latest
    restart: unless-stopped
    # Expose to the internal network; Caddy will proxy it in prod.
    expose:
      - "${SEARXNG_CONTAINER_LISTEN_PORT:-8080}"
    # Optional: for local/dev access without Caddy, map the port behind a profile
    ports:
      - target: ${SEARXNG_CONTAINER_LISTEN_PORT:-8080}
        published: ${DOCKER_HOST_PORT_SEARXNG_CONTAINER:-8080}
        protocol: tcp
        mode: host
    volumes:
      - ./searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=https://${SEARXNG_HOSTNAME:-localhost}/
      - UWSGI_WORKERS=${SEARXNG_UWSGI_WORKERS:-4}
      - UWSGI_THREADS=${SEARXNG_UWSGI_THREADS:-4}
      - SEARXNG_SECRET=${SEARXNG_SECRET}
      SEARXNG_PORT: ${SEARXNG_CONTAINER_LISTEN_PORT:-8080} 
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    depends_on:
      redis:
        condition: service_healthy
    networks: [app]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:${SEARXNG_CONTAINER_LISTEN_PORT:-8080}/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

#---------------------------------------------------------------------------
# caddy service
#---------------------------------------------------------------------------
  # Only runs in production
  caddy:
    container_name: caddy_container
    image: caddy:alpine
    depends_on:
      - n8n
    ports:
      - "80:80"
      - "443:443"
    environment:
      ACME_EMAIL: ${ACME_EMAIL}
      N8N_HOSTNAME: ${N8N_PUBLIC_HOSTNAME}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks: [app]
    restart: unless-stopped
    profiles: ["prod"]

networks:
  app:

volumes:
  postgres_data:
  caddy_data:
  caddy_config:
